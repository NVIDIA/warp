# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Makefile for Warp C++ CUBIN Launch Example
#
# This builds a standalone C++ program that loads and launches
# Warp-compiled kernels from CUBIN files.

# Compiler
NVCC := nvcc

# Target executable (named after example directory)
TARGET := 00_cubin_launch

# Source files
SOURCES := main.cu

# Find the CUBIN file generated by Warp (deferred evaluation)
CUBIN_FILE = $(shell ls generated/wp___main__.sm*.cubin 2>/dev/null | head -1)

# Kernel name (predictable with strip_hash=True)
KERNEL_NAME := saxpy_cuda_kernel_forward

# Warp native directory (relative path from example to repo root)
# Override by setting WARP_NATIVE_DIR environment variable
WARP_NATIVE_DIR ?= ../../../native
WARP_INCLUDE := $(WARP_NATIVE_DIR)

# Compiler flags
# Note: No -arch flag needed - this is host-only code using CUDA Driver API
# Use -isystem for Warp headers to suppress library warnings
# Note: CUBIN_FILE is passed at compile time (dynamic, depends on GPU)
NVCC_FLAGS := -std=c++17 \
              -O3 \
              -isystem $(WARP_INCLUDE) \
              -DKERNEL_NAME='"$(KERNEL_NAME)"' \
              -Xcompiler -Wall

# Linker flags
LDFLAGS := -lcuda

# Sentinel file to track CUBIN generation (actual CUBIN name varies by GPU)
CUBIN_SENTINEL := generated/.cubin_compiled

# Default target - build everything
.PHONY: all
all: $(TARGET)

# Generate CUBIN file (dependency for target)
$(CUBIN_SENTINEL): compile_kernel.py
	@uv run compile_kernel.py 2>/dev/null || python3 compile_kernel.py
	@touch $(CUBIN_SENTINEL)
	@echo ""

# Build the executable (depends on CUBIN being generated)
$(TARGET): $(CUBIN_SENTINEL) $(SOURCES)
	@if [ ! -d "$(WARP_INCLUDE)" ]; then \
		echo "Error: Warp native directory not found at: $(WARP_INCLUDE)"; \
		echo "Make sure you're running from warp/examples/cpp/00_cubin_launch/"; \
		echo "Or set WARP_NATIVE_DIR to point to warp/native/"; \
		exit 1; \
	fi
	@CUBIN_FILE_FOUND=$$(ls generated/wp___main__.sm*.cubin 2>/dev/null | head -1); \
	if [ -z "$$CUBIN_FILE_FOUND" ]; then \
		echo "Error: CUBIN compilation failed or generated file not found."; \
		exit 1; \
	fi; \
	COMPUTE_CAP_FOUND=$$(basename "$$CUBIN_FILE_FOUND" .cubin 2>/dev/null | sed 's/.*sm//'); \
	echo "Building C++ launcher..."; \
	echo "  CUBIN file: $$CUBIN_FILE_FOUND"; \
	echo "  Target architecture: sm_$$COMPUTE_CAP_FOUND"; \
	echo "  Kernel name: $(KERNEL_NAME)"; \
	$(NVCC) -arch=sm_$$COMPUTE_CAP_FOUND $(NVCC_FLAGS) \
		-DCUBIN_FILE='"'$$CUBIN_FILE_FOUND'"' \
		$(SOURCES) -o $(TARGET) $(LDFLAGS) && \
	echo "" && \
	echo "Build successful! Run with: ./00_cubin_launch"

# Build only the C++ program (assumes CUBIN already exists)
.PHONY: cpp
cpp: $(SOURCES)
	@if [ ! -d "$(WARP_INCLUDE)" ]; then \
		echo "Error: Warp native directory not found at: $(WARP_INCLUDE)"; \
		echo "Make sure you're running from warp/examples/cpp/00_cubin_launch/"; \
		echo "Or set WARP_NATIVE_DIR to point to warp/native/"; \
		exit 1; \
	fi
	@CUBIN_FILE_FOUND=$$(ls generated/wp___main__.sm*.cubin 2>/dev/null | head -1); \
	if [ -z "$$CUBIN_FILE_FOUND" ]; then \
		echo "Error: No CUBIN file found. Run 'python compile_kernel.py' first."; \
		exit 1; \
	fi; \
	COMPUTE_CAP_FOUND=$$(basename "$$CUBIN_FILE_FOUND" .cubin 2>/dev/null | sed 's/.*sm//'); \
	echo "Building C++ launcher (skipping kernel compilation)..."; \
	echo "  CUBIN file: $$CUBIN_FILE_FOUND"; \
	echo "  Target architecture: sm_$$COMPUTE_CAP_FOUND"; \
	$(NVCC) -arch=sm_$$COMPUTE_CAP_FOUND $(NVCC_FLAGS) \
		-DCUBIN_FILE='"'$$CUBIN_FILE_FOUND'"' \
		$(SOURCES) -o $(TARGET) $(LDFLAGS) && \
	echo "" && \
	echo "Build successful! Run with: ./00_cubin_launch"

# Clean build artifacts
.PHONY: clean
clean:
	rm -f $(TARGET)
	@echo "Cleaned build artifacts"

# Clean everything including generated files
.PHONY: distclean
distclean: clean
	rm -rf generated/
	@echo "Cleaned all generated files"

# Help target
.PHONY: help
help:
	@echo "Warp C++ CUBIN Launch Example - Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  all (default)   - Build everything (auto-compiles kernel if needed)"
	@echo "  cpp             - Build only C++ program (for iterating on C++ code)"
	@echo "  clean           - Remove build artifacts"
	@echo "  distclean       - Remove build artifacts and generated/ directory"
	@echo "  help            - Show this help message"
	@echo ""
	@echo "Note: To recompile the kernel, run: python compile_kernel.py"
